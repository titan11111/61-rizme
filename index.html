<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover, maximum-scale=1.0" />
<title>リズムバトル × アクション棒人間</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121b26; --lane:#1a2430; --hit:#2a3647; --accent:#68e1ff; --ok:#4ade80; --warn:#fbbf24; --bad:#ef4444; --white:#eaf6ff;
    --note-size: 26.4px; /* ノート50%でも視認性維持 */
  }
  html,body{margin:0;height:100%;background:radial-gradient(1200px 600px at 10% 0%, #0f1721 0%, #090d12 60%, #070a0f 100%);color:var(--white);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif;}
  *{box-sizing:border-box}
  button{background:linear-gradient(180deg,#1f2b3a,#172232);border:1px solid #223043;border-radius:14px;color:var(--white);padding:12px 16px;font-weight:700;letter-spacing:.02em;cursor:pointer;transition:transform .06s ease, filter .12s ease, background .2s ease;}
  button:hover{transform:translateY(-1px);} button:active{transform:translateY(0)}
  .scene{display:none;min-height:100%;} .scene.active{display:block}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .title{font-size:clamp(28px,6vw,48px);font-weight:800;letter-spacing:.03em;margin:6px 0 4px}
  .subtitle{opacity:.8;margin:0 0 12px 2px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:linear-gradient(180deg,#121b26,#0e1620);border:1px solid #1b2836;border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .center{display:flex;align-items:center;justify-content:center;text-align:center}
  .pill{padding:6px 10px;border-radius:999px;background:#0f1b28;border:1px solid #1b2a3a;font-size:12px;opacity:.9;display:inline-flex;align-items:center;gap:6px}
  .pill input{accent-color:#68e1ff}

  /* HUD */
  #hud{display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-bottom:10px}
  #hud .stat{background:#132033;border:1px solid #1e2b3b;border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:baseline}
  #hud .stat b{font-size:18px}
  #gaugeWrap{flex:1;display:flex;align-items:center;gap:10px}
  #hpbar{height:12px;flex:1;background:#192535;border-radius:999px;overflow:hidden;border:1px solid #1f2d3f}
  #hpbar>i{display:block;height:100%;width:100%;background:linear-gradient(90deg,#16a34a,#4ade80);transition:width .12s linear}
  #judge{min-width:100px;text-align:center;font-weight:900;letter-spacing:.05em}

  /* Stage */
  #stage{position:relative;display:grid;grid-template-columns: 320px 1fr;gap:16px;}
  #fight{position:relative;background:linear-gradient(180deg,#0e1620,#0b1119);border:1px solid #1a2736;border-radius:18px;overflow:hidden;min-height:340px;display:flex;align-items:center;justify-content:center}
  #fight.shake{animation: shake .25s ease}
  @keyframes shake{0%,100%{transform:translate(0)}25%{transform:translate(-6px,2px)}50%{transform:translate(6px,-2px)}75%{transform:translate(-4px,3px)}}
  #fight.flash::after{
    content:""; position:absolute; inset:0; background:radial-gradient(circle at 60% 60%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%);
    animation: flash .18s ease; pointer-events:none;
  }
  @keyframes flash{0%{opacity:1}100%{opacity:0}}
  #gameCanvas{width:100%;height:100%;background:#1a202c;border-radius:0.75rem;box-shadow: inset 0 0 0 1px rgba(255,255,255,.05)}
  .hit{position:absolute;right:18px;bottom:86px;width:22px;height:22px;border-radius:50%;background:radial-gradient(circle at 40% 40%, #9be4ff, #3dd0ff, transparent 70%);opacity:0;}
  .hit.show{animation: hit .35s ease}
  @keyframes hit{0%{opacity:.95;transform:scale(.6)}100%{opacity:0;transform:scale(2.4)}}

  /* Lanes */
  #lanes{position:relative;background:linear-gradient(180deg,#0b1118,#0b141d);border:1px solid #1a2736;border-radius:18px;overflow:hidden;min-height:340px;padding:10px;display:grid;grid-template-columns:repeat(3, 1fr);gap:10px}
  .lane{position:relative;background:linear-gradient(180deg, #121b26, #0e1621);border:1px solid #1b2836;border-radius:12px;overflow:hidden}
  .lane .label{position:absolute;left:10px;top:8px;font-size:12px;opacity:.8}
  .lane .hitline{position:absolute;left:0;right:0;bottom:58px;height:3px;background:linear-gradient(90deg, transparent, var(--hit), transparent)}
  .lane .note{position:absolute;left:50%;transform:translate(-50%, -50%);width:var(--note-size);height:var(--note-size);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.45)}
  .note.punch{background:linear-gradient(180deg,#ff7d7d,#ff3d3d)}
  .note.kick{background:linear-gradient(180deg,#ffd07d,#ff9a1f)}
  .note.jump{background:linear-gradient(180deg,#9be4ff,#4fd1ff)}
  .lane .spark{position:absolute;left:50%;bottom:58px;transform:translateX(-50%);width:10px;height:10px;border-radius:50%;background:radial-gradient(circle, #fff, transparent 60%);opacity:0}
  .lane .spark.show{animation:spark .3s ease}
  @keyframes spark{0%{opacity:1;transform:translateX(-50%) scale(.5)}100%{opacity:0;transform:translateX(-50%) scale(3)}}

  /* Controls */
  #controls{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .ctl{padding:12px 10px;font-size:16px;font-weight:800;width:90%;}

  /* Result / Ending */
  .big{font-size:clamp(28px,6vw,52px);font-weight:900;letter-spacing:.04em}
  .result-grid{display:grid;grid-template-columns:repeat(2, minmax(220px,1fr));gap:14px;max-width:720px;margin:20px auto}
  .result-item{background:#111a26;border:1px solid #1c2a3a;border-radius:12px;padding:14px;text-align:center}
  .rank{font-size:42px;font-weight:900}
  .ending{max-width:860px;margin:0 auto;line-height:1.9;opacity:.95}
  .kbd{display:inline-block;padding:2px 8px;border-radius:6px;background:#101826;border:1px solid #1b2a3b;font-family:ui-monospace, "SF Mono", Menlo, Consolas, monospace}

  @media (max-width: 920px){ #stage{grid-template-columns:1fr} }
</style>
</head>
<body>
<audio id="bgm" preload="auto" loop></audio>

<div id="scene-start" class="scene active">
  <div class="wrap">
    <div class="card center">
      <div>
        <div class="pill">Rhythm × Action</div>
        <h1 class="title">リズムバトル：棒人間でパンチ・キック・ジャンプ</h1>
        <p class="subtitle">押すだけで技。技で音楽。子ども向け・1ファイル。</p>

        <div class="row" style="justify-content:center;margin:10px 0 6px;gap:10px">
          <label class="pill"><input type="radio" name="diff" value="easy"> EASY</label>
          <label class="pill"><input type="radio" name="diff" value="normal" checked> NORMAL</label>
          <label class="pill"><input type="radio" name="diff" value="hard"> HARD</label>
        </div>

        <div class="row" style="justify-content:center;margin:12px 0 6px">
          <button id="btnStart">はじめる</button>
          <button id="btnHow">あそびかた</button>
        </div>
        <p class="subtitle">キーボード: <span class="kbd">D</span>=パンチ / <span class="kbd">F</span>=キック / <span class="kbd">Space</span>=ジャンプ</p>
      </div>
    </div>
    <div id="how" class="card" style="display:none;margin-top:14px">
      <b>あそびかた</b>
      <ol>
        <li>ノーツが下に来たら、同じ技のキーを押す。</li>
        <li>当たると判定と音が鳴り、敵HPが減る。</li>
        <li>HPを0にすればクリア。スマホは下の3ボタンでもOK。</li>
      </ol>
    </div>
  </div>
</div>

<div id="scene-play" class="scene">
  <div class="wrap">
    <div id="hud">
      <div class="stat"><span>スコア</span> <b id="score">0</b></div>
      <div class="stat"><span>コンボ</span> <b id="combo">0</b></div>
      <div class="stat"><span>判定</span> <b id="judge">-</b></div>
      <div id="gaugeWrap" class="stat" style="flex:1"><span>ボスHP</span>
        <div id="hpbar"><i style="width:100%"></i></div>
      </div>
      <div class="stat"><span>のこり</span> <b id="timeLeft">--</b></div>
      <div class="stat"><span>診断</span> <b id="hc">-</b></div>
    </div>

    <div id="stage">
      <div id="fight" class="card">
        <canvas id="gameCanvas" aria-label="stickman stage"></canvas>
        <div class="hit" id="hitFx"></div>
      </div>

      <div id="lanes" class="card">
        <div class="lane" data-lane="0"><div class="label">パンチ <span class="kbd">D</span></div><div class="hitline"></div><div class="spark"></div></div>
        <div class="lane" data-lane="1"><div class="label">キック <span class="kbd">F</span></div><div class="hitline"></div><div class="spark"></div></div>
        <div class="lane" data-lane="2"><div class="label">ジャンプ <span class="kbd">Space</span></div><div class="hitline"></div><div class="spark"></div></div>
      </div>
    </div>

    <div id="controls" class="row">
      <button class="ctl" data-lane="0">パンチ</button>
      <button class="ctl" data-lane="1">キック</button>
      <button class="ctl" data-lane="2">ジャンプ</button>
    </div>
  </div>
</div>

<div id="scene-result" class="scene">
  <div class="wrap center">
    <div class="card">
      <div class="big" id="resultTitle">ステージ クリア</div>
      <div class="result-grid">
        <div class="result-item">PERFECT<br><b id="rPerfect">0</b></div>
        <div class="result-item">GREAT<br><b id="rGreat">0</b></div>
        <div class="result-item">GOOD<br><b id="rGood">0</b></div>
        <div class="result-item">MISS<br><b id="rMiss">0</b></div>
      </div>
      <div class="rank" id="rRank">S</div>
      <div class="row" style="justify-content:center;margin-top:8px">
        <button id="toEnding">エンディングへ</button>
        <button id="retry">リトライ</button>
      </div>
    </div>
  </div>
</div>

<div id="scene-ending" class="scene">
  <div class="wrap center">
    <div class="card ending">
      <div class="big">ありがとう</div>
      <p>技のリズムが街じゅうに広がった。泣いていた子も笑って、みんなで手をたたく。敵だったはずの相手も、いつのまにか一緒にステップを踏んでいる。</p>
      <p>音楽は、こころをつなぐ魔法。きょうのヒーローは、きみ。</p>
      <div class="row" style="justify-content:center;margin-top:8px">
        <button id="restart">タイトルへ</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // --------- Utilities
  const qs = (s, root=document) => root.querySelector(s);
  const qsa = (s, root=document) => [...root.querySelectorAll(s)];
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

  // --------- Canvas / Stickman
  const canvas = qs('#gameCanvas');
  const ctx = canvas.getContext('2d', { alpha: true });
  let dpr = Math.max(1, window.devicePixelRatio || 1);

  function fitCanvas(){
    const rect = canvas.getBoundingClientRect();
    ctx.setTransform(1,0,0,1,0,0);
    canvas.width = Math.max(1, Math.floor(rect.width * dpr));
    canvas.height = Math.max(1, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  // 表示切替でサイズ0になる対策：scene変更時にも都度呼ぶ
  const resizeObserver = new ResizeObserver(()=>{ dpr = Math.max(1, window.devicePixelRatio || 1); fitCanvas(); });
  resizeObserver.observe(canvas);
  window.addEventListener('resize', fitCanvas);
  fitCanvas();

  const stick = {
    x: () => (canvas.width / dpr) * 0.5,
    groundY: () => (canvas.height / dpr) - 50,
    width: 30, height: 50, color: '#06b6d4',
    vy: 0, state: 'idle', timer: 0
  };

  function drawArms(x,y,a){
    ctx.beginPath(); ctx.moveTo(x, y+25); ctx.lineTo(x+10, y+35 + a*5); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x, y+25); ctx.lineTo(x-10, y+35 - a*5); ctx.stroke();
  }
  function drawLegs(x,y,a){
    ctx.beginPath(); ctx.moveTo(x, y+40); ctx.lineTo(x+8, y+50 - a*5); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x, y+40); ctx.lineTo(x-8, y+50 + a*5); ctx.stroke();
  }
  function drawGround(){
    const w = canvas.width / dpr;
    const gy = stick.groundY();
    ctx.strokeStyle = '#475569'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke();
  }
  function drawStickman(){
    const w = canvas.width / dpr, h = canvas.height / dpr;
    ctx.clearRect(0,0,w,h);
    drawGround();
    ctx.fillStyle = stick.color;
    ctx.strokeStyle = '#f0f9ff';
    ctx.lineWidth = 3;
    const cx = stick.x();
    const cy = stickY() - stick.height;

    // body
    ctx.beginPath(); ctx.moveTo(cx, cy+20); ctx.lineTo(cx, cy+40); ctx.stroke();
    // head
    ctx.beginPath(); ctx.arc(cx, cy+10, 10, 0, Math.PI*2); ctx.fill();

    // limbs by state
    if(stick.state==='punching'){
      ctx.beginPath(); ctx.moveTo(cx, cy+25); ctx.lineTo(cx+25, cy+20); ctx.stroke();
      drawLegs(cx, cy, 0);
    } else if(stick.state==='kicking'){
      drawArms(cx, cy, -0.5);
      ctx.beginPath(); ctx.moveTo(cx, cy+40); ctx.lineTo(cx+20, cy+35); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx, cy+40); ctx.lineTo(cx-5, cy+50); ctx.stroke();
    } else if(stick.state==='jumping'){
      drawArms(cx, cy, 1);
      drawLegs(cx, cy, 0.5);
    } else {
      drawArms(cx, cy, 0);
      drawLegs(cx, cy, 0);
    }
  }
  function stickY(){ return _y; }
  let _y = stick.groundY();

  function updateStick(){
    if(stick.state==='jumping'){
      stick.vy += 0.8;
      _y += stick.vy;
      const gy = stick.groundY();
      if(_y >= gy){ _y = gy; stick.state='idle'; stick.vy = 0; }
    }
    if(stick.timer>0){ stick.timer--; if(stick.timer===0 && stick.state!=='jumping') stick.state='idle'; }
  }
  function doAction(lane){
    if(lane===0 && stick.state==='idle'){ stick.state='punching'; stick.timer=15; }
    else if(lane===1 && stick.state==='idle'){ stick.state='kicking'; stick.timer=20; }
    else if(lane===2 && stick.state==='idle'){ stick.state='jumping'; stick.vy=-15; }
  }

  // --------- Audio (WebAudio; synth voices for Punch/Kick/Jump)
  let AC; // created on first user gesture
  function ensureAC(){ if(!AC){ AC = new (window.AudioContext||window.webkitAudioContext)(); } if(AC.state === 'suspended'){ AC.resume(); } }

  function env(node, t=0.12, a=0.001){
    const g = AC.createGain(); g.gain.setValueAtTime(0, AC.currentTime); g.gain.linearRampToValueAtTime(1, AC.currentTime + a); g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime + t);
    node.connect(g); g.connect(AC.destination); return g;
  }
  function noiseBuffer(){ const len = AC.sampleRate * 0.25; const b = AC.createBuffer(1,len,AC.sampleRate); const d = b.getChannelData(0); for(let i=0;i<len;i++){ d[i] = Math.random()*2-1; } return b; }
  function playPunch(v=1){ ensureAC();
    const n = AC.createBufferSource(); n.buffer = noiseBuffer(); const bp = AC.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value = 900; bp.Q.value=3; n.connect(bp); const g1 = AC.createGain(); g1.gain.value = 0.3*v; bp.connect(g1); const eg1 = env(g1, 0.08);
    const o = AC.createOscillator(); o.type='triangle'; o.frequency.setValueAtTime(220, AC.currentTime); o.frequency.exponentialRampToValueAtTime(140, AC.currentTime+0.09); const g2 = AC.createGain(); g2.gain.value = 0.25*v; const eg2 = env(g2, 0.1);
    n.start(); o.start(); o.stop(AC.currentTime+0.12); n.stop(AC.currentTime+0.1);
    o.connect(g2); eg2.connect(AC.destination); eg1.connect(AC.destination);
  }
  function playKick(v=1){ ensureAC();
    const o = AC.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(120, AC.currentTime); o.frequency.exponentialRampToValueAtTime(50, AC.currentTime+0.18);
    const g = AC.createGain(); g.gain.value = 0.5*v; const eg = env(g, 0.22, 0.004);
    o.connect(g); eg.connect(AC.destination); o.start(); o.stop(AC.currentTime+0.24);
    const n = AC.createBufferSource(); n.buffer = noiseBuffer(); const hp = AC.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1800; n.connect(hp); const cg = AC.createGain(); cg.gain.value = 0.15*v; const ec = env(cg, 0.05, 0.001); hp.connect(cg); ec.connect(AC.destination); n.start(); n.stop(AC.currentTime+0.04);
  }
  function playJump(v=1){ ensureAC();
    const n = AC.createBufferSource(); n.buffer = noiseBuffer(); const bp = AC.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1500; bp.Q.value=0.8; n.connect(bp); const g1 = AC.createGain(); g1.gain.value = 0.25*v; const eg1 = env(g1, 0.3, 0.008); bp.connect(g1); eg1.connect(AC.destination);
    const o = AC.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(660, AC.currentTime); o.frequency.exponentialRampToValueAtTime(880, AC.currentTime+0.12); const g2 = AC.createGain(); g2.gain.value = 0.18*v; const eg2 = env(g2, 0.2, 0.004); o.connect(g2); eg2.connect(AC.destination); o.start(); o.stop(AC.currentTime+0.22); n.start(); n.stop(AC.currentTime+0.28);
  }
  const VOICES = [playPunch, playKick, playJump];

  // --------- Game State
  const State = {
    difficulty: 'normal',
    chart: [],
    idxByLane: [0,0,0],
    songLength: 60,
    appear: 2.75,
    windows: { perfect: .09, great: .14, good: .20 },
    score: 0, combo: 0, bestCombo: 0,
    tallies: {perfect:0, great:0, good:0, miss:0},
    hp: 100, hpMax: 100,
    startAt: 0,
    running: false,
    rafId: null
  };

  // --------- Chart Generator（ノート量 50%）
  function generateChart(diff='normal'){
    const cfg = {
      easy:   { bpm: 100, bars: 16, density: 1.0 },
      normal: { bpm: 120, bars: 18, density: 1.35 },
      hard:   { bpm: 140, bars: 20, density: 1.7 }
    }[diff];
    const beat = 60/cfg.bpm;
    const chart = [];
    let t = 2.0; // lead-in
    const stepsPerBar = 8;
    const chance = cfg.density;

    for(let bar=0;bar<cfg.bars;bar++){
      for(let step=0;step<stepsPerBar;step++){
        const lanePattern = [0,1,2];
        // 乱数判定を0.5倍して密度を半減
        if(Math.random() < 0.65*chance*0.5){ chart.push({t, lane: lanePattern[(bar+step)%3]}); }
        if(Math.random() < 0.35*chance*0.5 && step%2===0){ chart.push({t, lane: (lanePattern[(bar+step+1)%3])}); }
        if(diff==='hard' && Math.random()<0.2*0.5 && step%2===1){ chart.push({t, lane: (lanePattern[(bar+step+2)%3])}); }
        t += beat/2;
      }
      if(bar%4===3){ t += beat; }
    }
    chart.sort((a,b)=>a.t-b.t);
    return {chart, length: t + 2.0};
  }

  // --------- DOM Notes
  function spawnNotes(){
    qsa('.lane').forEach(l => l.querySelectorAll('.note').forEach(n=>n.remove()));
    for(const n of State.chart){
      const laneEl = qs(`.lane[data-lane="${n.lane}"]`);
      const el = document.createElement('div');
      el.className = `note ${['punch','kick','jump'][n.lane]}`;
      el.style.top = '-100px';
      el.dataset.t = n.t;
      laneEl.appendChild(el);
      n.el = el;
    }
    State.idxByLane = [0,0,0];
  }

  function updateNotes(now){
    const H = qs('#lanes').clientHeight - 80;
    const appear = State.appear;
    for(const n of State.chart){
      if(n.hit) continue;
      const dt = n.t - now;
      if(dt < -State.windows.good){
        n.hit = 'miss';
        State.tallies.miss++;
        State.combo = 0; updateHUD();
      }
      if(dt < appear){
        const y = clamp((1 - (dt/appear)) * H, 0, H);
        n.el.style.top = (y + 16) + 'px';
        n.el.style.opacity = dt<0? 0.4 : 1;
      }
    }
  }

  // --------- Input & Judgement
  function tryHit(lane){
    ensureAC();
    if(!State.running){ doAction(lane); VOICES[lane](0.7); return; }
    const now = AC.currentTime - State.startAt;
    let target = null, idx = -1, bestAbs = 999;
    for(let i = State.idxByLane[lane]; i < State.chart.length; i++){
      const n = State.chart[i];
      if(n.lane !== lane || n.hit) continue;
      const d = n.t - now; const ad = Math.abs(d);
      if(ad < bestAbs){ bestAbs = ad; target = n; idx = i; }
      if(n.t > now + State.windows.good) break;
    }
    if(target && bestAbs <= State.windows.good){
      const j = bestAbs <= State.windows.perfect ? 'perfect' : bestAbs <= State.windows.great ? 'great' : 'good';
      hitEffect(lane, j);
      target.hit = j; target.el.remove();
      State.idxByLane[lane] = idx+1;
      applyJudge(j);
      doAction(lane);
      if(checkClear()) finish(true);
    } else {
      State.tallies.miss++; State.combo=0; judgeFlash('MISS', 'bad'); shake(); updateHUD();
      doAction(lane);
    }
  }

  function applyJudge(j){
    const pts = {perfect: 1200, great: 800, good: 400}[j];
    const dmg = {perfect: 4, great: 3, good: 1}[j];
    State.score += pts + Math.floor(State.combo*3);
    State.combo++; State.bestCombo = Math.max(State.bestCombo, State.combo);
    State.tallies[j]++;
    setHP(State.hp - dmg);
    judgeFlash(j.toUpperCase(), j==='perfect'?'ok':j==='great'?'warn':'');
    updateHUD();
    const vol = j==='perfect'?1:j==='great'?0.85:0.7;
    VOICES[lastLane](vol);
  }

  function judgeFlash(text, type){
    const el = qs('#judge');
    el.textContent = text;
    el.style.color = type==='ok'? '#4ade80' : type==='warn'? '#fbbf24' : type==='bad'? '#ef4444' : '#eaf6ff';
  }

  function setHP(v){ State.hp = clamp(v,0,State.hpMax); qs('#hpbar>i').style.width = ((State.hp/State.hpMax)*100)+'%'; if(v < State.hpMax){ flashEnemy(); } }
  function flashEnemy(){ const f = qs('#fight'); f.classList.add('flash'); setTimeout(()=> f.classList.remove('flash'), 160); }
  function shake(){ const f = qs('#fight'); f.classList.add('shake'); setTimeout(()=>f.classList.remove('shake'), 220); }

  function hitEffect(lane){
    const l = qs(`.lane[data-lane="${lane}"] .spark`); l.classList.remove('show'); void l.offsetWidth; l.classList.add('show');
    const fx = qs('#hitFx'); fx.classList.remove('show'); void fx.offsetWidth; fx.classList.add('show');
  }

  // --------- Loop
  function loop(){
    if(!State.running) return;
    const now = AC.currentTime - State.startAt;
    updateNotes(now);
    updateStick();
    drawStickman();
    const left = Math.max(0, State.songLength - now);
    qs('#timeLeft').textContent = left.toFixed(1)+'s';
    if(now > State.songLength + 1){ finish(false); return; }
    State.rafId = requestAnimationFrame(loop);
  }

  function checkClear(){ return State.hp <= 0; }

  function finish(cleared){
    State.running = false; if(State.rafId) cancelAnimationFrame(State.rafId);
    stopBGM();
    showScene('scene-result');
    qs('#resultTitle').textContent = cleared? 'ステージ クリア' : 'ステージ クリアならず';
    qs('#rPerfect').textContent = State.tallies.perfect;
    qs('#rGreat').textContent = State.tallies.great;
    qs('#rGood').textContent = State.tallies.good;
    qs('#rMiss').textContent = State.tallies.miss;
    const totalHit = State.tallies.perfect+State.tallies.great+State.tallies.good+State.tallies.miss;
    const acc = totalHit? ( (State.tallies.perfect*1 + State.tallies.great*0.7 + State.tallies.good*0.4) / totalHit ) : 0;
    const rank = acc>0.88?'S':acc>0.75?'A':acc>0.6?'B':acc>0.45?'C':'D';
    qs('#rRank').textContent = rank;
  }

  function updateHUD(){ qs('#score').textContent = State.score; qs('#combo').textContent = State.combo; }

  // --------- Scene & BGM
  function showScene(id){
    qsa('.scene').forEach(s=>s.classList.remove('active'));
    const target = qs('#'+id);
    target.classList.add('active');
    if(id==='scene-play'){ fitCanvas(); drawStickman(); } // ★ 表示後にキャンバス調整
  }

  const bgm = document.getElementById("bgm");
  const BGM_MAP = { easy:"audio/The_Swing_of_Time.mp3", normal:"audio/The_Swing_of_Time.mp3", hard:"audio/The_Swing_of_Time.mp3" };
  function playBGM(){
    const src = BGM_MAP[State.difficulty] || "audio/The_Swing_of_Time.mp3";
    if(bgm.getAttribute("src") !== src) bgm.setAttribute("src", src);
    bgm.volume = 0.4;
    bgm.currentTime = 0;
    bgm.play().catch(e => console.log("BGM再生エラー:", e));
  }
  function stopBGM(){ bgm.pause(); bgm.currentTime = 0; }
  function getSelectedDiff(){ return (qs('input[name="diff"]:checked')?.value) || 'normal'; }

  // --------- Health Check（3回）
  function runHealthChecks(times=3){
    let i=0;
    const hcEl = qs('#hc');
    const once = () => {
      i++;
      const acOk = !!AC && (AC.state==='running');
      const bgmOk = !bgm.paused && bgm.currentTime>=0;
      const canvasOk = canvas.width>0 && canvas.height>0;
      const ok = acOk && bgmOk && canvasOk;
      hcEl.textContent = ok ? `OK ${i}/${times}` : `NG ${i}/${times}`;
      console.log(`[Check ${i}] AC:${acOk} BGM:${bgmOk} Canvas:${canvasOk}`);
      if(i<times) setTimeout(once, 500);
    };
    setTimeout(once, 250);
  }

  // --------- Game Start
  function newGame(){
    ensureAC();
    State.difficulty = getSelectedDiff();

    const {chart,length} = generateChart(State.difficulty);
    State.chart = chart; State.songLength = length;
    State.hpMax = Math.max(60, Math.floor(chart.length*2.8)); State.hp = State.hpMax;
    State.score=0; State.combo=0; State.bestCombo=0; State.tallies={perfect:0,great:0,good:0,miss:0};
    spawnNotes();
    qs('#hpbar>i').style.width='100%';

    _y = stick.groundY(); stick.vy=0; stick.state='idle'; stick.timer=0;

    playBGM();
    drawStickman(); // ★ 初期描画

    setTimeout(()=>{ State.startAt = AC.currentTime; State.running = true; loop(); }, 300);

    runHealthChecks(3); // ★ 3回チェック
  }

  // --------- Controls
  let lastLane = 0;
  const keyMap = { 'd':0, 'f':1, ' ':2, 'j':2 };
  window.addEventListener('keydown', (e)=>{
    const key = e.key.toLowerCase();
    if(keyMap.hasOwnProperty(key)){ e.preventDefault(); const lane = keyMap[key]; lastLane = lane; tryHit(lane); }
  }, {passive:false});
  qsa('.ctl').forEach(b=> {
    b.addEventListener('touchstart', (e)=> {
      e.preventDefault();
      const lane = parseInt(b.dataset.lane,10);
      lastLane = lane;
      tryHit(lane);
    }, {passive: false});
  });

  // --------- UI wiring
  qs('#btnStart').addEventListener('click', ()=>{ showScene('scene-play'); newGame(); });
  qs('#btnHow').addEventListener('click', ()=>{ const h=qs('#how'); h.style.display = (h.style.display==='none')?'block':'none'; });
  qs('#toEnding').addEventListener('click', ()=> showScene('scene-ending'));
  qs('#retry').addEventListener('click', ()=>{ showScene('scene-play'); newGame(); });
  qs('#restart').addEventListener('click', ()=>{ showScene('scene-start'); });

  // --------- Audio unlock（PC/モバイル）
  document.body.addEventListener('click', ensureAC, {once:true});
  document.body.addEventListener('touchstart', ensureAC, {once:true, passive:true});

  // initial draw
  drawStickman();
})();
</script>
</body>
</html>
