<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>メトロポリタン・リズム</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

    :root {
      --c-bg:#1a1a2e;
      --c-fg:#e0e0e0;
      --c-ac:#00ffff;
    }

    body{
      font-family:'Roboto Mono',monospace;
      background:var(--c-bg);
      color:var(--c-fg);
      margin:0;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    .game-container{
      position:relative;
      width:min(1200px,100vw);
      height:min(800px,90vh);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.4);
      border:2px solid var(--c-ac);
      border-radius:20px;
      padding:18px;
      box-shadow:0 0 40px rgba(0,255,255,.2);
      overflow:hidden;
    }

    .info-panel{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 16px;
      font-size:1.25rem;
      text-shadow:0 0 5px var(--c-ac);
      z-index:10;
    }
    .score-goal{color:var(--c-ac);font-size:1.1rem}

    .stage{
      position:relative;
      width:95%;
      height:520px;
      background:linear-gradient(to top,#2d2d5e,#1a1a2e);
      border-radius:12px;
      box-shadow:inset 0 0 20px rgba(0,255,255,.3);
      overflow:hidden;
    }

    .target-zone{
      position:absolute;left:30%;top:0;bottom:0;width:120px;
      background:rgba(255,255,255,.08);
      border-left:3px dashed var(--c-ac);
      border-right:3px dashed var(--c-ac);
      transform:translateX(-50%);
      z-index:5;
    }

    .note{
      position:absolute;right:-56px;width:50px;height:50px;border-radius:10px;
      box-shadow:0 0 15px;animation:pulse 1s infinite alternate;
    }
    .note.punch{background:#ff5252;box-shadow:0 0 15px #ff5252}
    .note.kick {background:#52ff52;box-shadow:0 0 15px #52ff52}
    .note.jump {background:#5252ff;box-shadow:0 0 15px #5252ff}

    @keyframes pulse{from{transform:scale(1)}to{transform:scale(1.05)}}

    .feedback-text{
      position:absolute;left:30%;top:40%;transform:translate(-50%,-50%);
      font-size:2.5rem;font-weight:700;opacity:0;animation:fadeOutUp .8s forwards;
      text-shadow:0 0 10px #fff;z-index:15;
    }
    .feedback-text.perfect{color:#fff}
    .feedback-text.great{color:#00ff00}
    .feedback-text.good{color:#ffff00}
    .feedback-text.miss{color:#ff4d4d}

    @keyframes fadeOutUp{
      from{transform:translate(-50%,-50%);opacity:1}
      to{transform:translate(-50%,-100%);opacity:0}
    }

    /* 棒人間（滑らかに動くようにパーツ分割） */
    .character-container{
      position:absolute;left:30%;bottom:24px;transform:translateX(-50%);z-index:10;
    }
    .character-svg{width:170px;height:170px;transform-origin:bottom center;transition:transform .18s ease}
    .character-svg line,.character-svg circle{
      stroke:#e8e8e8;stroke-width:6;fill:none;
      transition:transform .18s ease;
      transform-box:fill-box;transform-origin:top center;
    }
    /* 回転軸の個別微調整 */
    #rightArm,#leftArm{transform-origin:12px 6px}
    #rightLeg,#leftLeg{transform-origin:12px 6px}

    /* アクション姿勢 */
    .character-svg.punch #rightArm{transform:rotate(-85deg) translateY(-14px)}
    .character-svg.punch {transform:translateX(8px) rotate(3deg)}

    .character-svg.kick  #rightLeg{transform:rotate(65deg) translateY(-6px)}
    .character-svg.kick  {transform:translateX(-6px) rotate(-2deg)}

    .character-svg.jump{transform:translateY(-34px)}
    .character-svg.jump #leftArm{transform:rotate(20deg)}
    .character-svg.jump #rightArm{transform:rotate(-20deg)}
    .character-svg.jump #leftLeg{transform:rotate(-8deg)}
    .character-svg.jump #rightLeg{transform:rotate(8deg)}

    .controls{
      display:flex;gap:16px;margin-top:18px;z-index:10;flex-wrap:wrap;justify-content:center;
    }
    .control-btn{
      padding:14px 24px;font-size:1.1rem;font-weight:700;color:#fff;background:#3b3b5b;
      border:2px solid var(--c-ac);border-radius:10px;cursor:pointer;
      transition:transform .15s, box-shadow .15s; box-shadow:0 0 10px var(--c-ac);
      min-width:200px;
    }
    .control-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px var(--c-ac)}
    .control-btn:active{transform:translateY(0)}

    .control-btn.punch{background:#ff5252;border-color:#ff5252;box-shadow:0 0 10px #ff5252}
    .control-btn.kick {background:#52ff52;border-color:#52ff52;box-shadow:0 0 10px #52ff52}
    .control-btn.jump {background:#5252ff;border-color:#5252ff;box-shadow:0 0 10px #5252ff}

    .control-btn.active.punch{box-shadow:0 0 18px #ff5252}
    .control-btn.active.kick {box-shadow:0 0 18px #52ff52}
    .control-btn.active.jump {box-shadow:0 0 18px #5252ff}

    /* 画面オーバーレイ */
    .screen-overlay{
      position:absolute;inset:0;background:rgba(0,0,0,.82);
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:20;
    }
    .title{font-size:4rem;font-weight:700;text-shadow:0 0 15px var(--c-ac)}
    .start-button,.level-button{
      padding:18px 36px;font-size:1.8rem;font-weight:700;background:var(--c-ac);color:#102026;border:none;border-radius:14px;
      cursor:pointer;box-shadow:0 0 20px var(--c-ac);transition:transform .2s, box-shadow .2s;
    }
    .start-button:hover,.level-button:hover{transform:scale(1.06);box-shadow:0 0 28px var(--c-ac)}
    .level-select-container{display:flex;flex-direction:column;gap:16px}
    .level-button.locked{background:#555;color:#aaa;cursor:not-allowed;box-shadow:none;border:2px solid #555}

    /* スマホ横持ち最適化 */
    @media (max-width: 900px) and (orientation: landscape){
      .game-container{width:100vw;height:100vh;max-width:none;max-height:none;padding:10px}
      #gameContent{display:grid;grid-template-columns:2fr 1fr;grid-template-rows:auto 1fr auto;gap:10px;width:100%;height:100%}
      .info-panel{grid-column:1/3;font-size:1rem;padding:6px}
      .stage{grid-column:1/2;height:78vh}
      .controls{grid-column:2/3;flex-direction:column;align-items:stretch;justify-content:center}
      .control-btn{min-width:auto;width:100%}
      .character-svg{width:120px;height:120px}
      .feedback-text{font-size:2rem}
      .title{font-size:2.4rem}
    }

    /* スマホ縦持ちの安全策 */
    @media (max-width:640px) and (orientation:portrait){
      body{overflow-y:auto}
      .game-container{height:auto;max-height:none}
      .stage{height:46vh}
      .controls{flex-direction:column}
      .control-btn{width:100%}
      .title{font-size:2.4rem}
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center">
  <div id="gameContainer" class="game-container">

    <!-- スタート画面 -->
    <div id="startScreen" class="screen-overlay">
      <h1 class="title">メトロポリタン・リズム</h1>
      <p class="text-xl text-center mt-5">
        'A' 'S' 'D' または ← ↓ → / Space。<br>
        ※モバイルは最初のタップで音が出ます。
      </p>
      <button id="startButton" class="start-button">スタート</button>
    </div>

    <!-- 難易度選択 -->
    <div id="difficultySelectScreen" class="screen-overlay hidden">
      <h2 class="text-3xl font-bold mb-3">難易度を選択</h2>
      <div class="level-select-container">
        <button id="easyButton" class="level-button">かんたん</button>
        <button id="normalButton" class="level-button locked" disabled>ふつう</button>
        <button id="hardButton" class="level-button locked" disabled>むずかしい</button>
      </div>
    </div>

    <!-- レベルクリア -->
    <div id="levelClearScreen" class="screen-overlay hidden">
      <h2 class="text-4xl font-bold mb-4 text-green-400">レベルクリア</h2>
      <p class="text-2xl mb-6">次へ進みます</p>
      <button id="nextLevelButton" class="start-button">次のレベルへ</button>
    </div>

    <!-- エンディング -->
    <div id="endingScreen" class="screen-overlay hidden">
      <h2 class="text-4xl font-bold mb-4 text-yellow-400">ゲームクリア</h2>
      <p class="text-2xl mb-6">最終スコア: <span id="finalScore">0</span></p>
      <button id="playAgainButton" class="start-button">もう一度</button>
    </div>

    <!-- プレイ画面 -->
    <div id="gameContent" class="hidden w-full h-full flex flex-col items-center justify-center">
      <div class="info-panel">
        <div>スコア: <span id="score">0</span></div>
        <div>コンボ: <span id="combo">0</span></div>
        <div class="score-goal">クリアまで: <span id="scoreGoal">0</span></div>
      </div>

      <div id="stage" class="stage mt-3">
        <div class="target-zone"></div>

        <!-- 棒人間：関節単位で制御 -->
        <div class="character-container">
          <svg class="character-svg" viewBox="0 0 200 200">
            <!-- 頭 -->
            <circle id="head" cx="100" cy="38" r="16"/>
            <!-- 胴 -->
            <line id="torso" x1="100" y1="54" x2="100" y2="120"/>
            <!-- 腕（肩の位置 y=70） -->
            <line id="leftArm"  x1="100" y1="70" x2="64"  y2="100"/>
            <line id="rightArm" x1="100" y1="70" x2="136" y2="100"/>
            <!-- 脚（股関節 y=120） -->
            <line id="leftLeg"  x1="100" y1="120" x2="78"  y2="162"/>
            <line id="rightLeg" x1="100" y1="120" x2="122" y2="162"/>
          </svg>
        </div>
      </div>

      <div id="controls" class="controls">
        <button id="punchButton" class="control-btn punch">パンチ (A / ←)</button>
        <button id="kickButton"  class="control-btn kick">キック (S / ↓)</button>
        <button id="jumpButton"  class="control-btn jump">ジャンプ (D / → / Space)</button>
      </div>
    </div>

    <audio id="bgm" loop>
      <source src="https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3" type="audio/mp3" />
    </audio>
  </div>

  <script type="module">
    // ====== 進行・UI ======
    const startScreen  = document.getElementById('startScreen');
    const difficultySelectScreen = document.getElementById('difficultySelectScreen');
    const levelClearScreen = document.getElementById('levelClearScreen');
    const endingScreen = document.getElementById('endingScreen');
    const gameContent  = document.getElementById('gameContent');

    const stage        = document.getElementById('stage');
    const scoreDisplay = document.getElementById('score');
    const comboDisplay = document.getElementById('combo');
    const scoreGoalDisplay = document.getElementById('scoreGoal');

    const punchButton  = document.getElementById('punchButton');
    const kickButton   = document.getElementById('kickButton');
    const jumpButton   = document.getElementById('jumpButton');

    const easyButton   = document.getElementById('easyButton');
    const normalButton = document.getElementById('normalButton');
    const hardButton   = document.getElementById('hardButton');
    const nextLevelButton = document.getElementById('nextLevelButton');
    const playAgainButton = document.getElementById('playAgainButton');

    const finalScoreDisplay = document.getElementById('finalScore');
    const bgm = document.getElementById('bgm');

    const characterSvg = document.querySelector('.character-svg');

    // ====== ゲーム状態 ======
    let score = 0, combo = 0, notes = [], isGameRunning = false;
    let bpm, noteSpeedMultiplier, noteSpawnInterval, scoreToClearLevel, currentLevel = 0;
    let unlockedLevel = 1; // ローカル保持（Firebase無効化）

    const noteTypes = ['punch','kick','jump'];
    const keyMap = {
      'KeyA':'punch','ArrowLeft':'punch',
      'KeyS':'kick','ArrowDown':'kick',
      'KeyD':'jump','ArrowRight':'jump','Space':'jump'
    };

    // 難易度（スコアクリア制）
    const difficultySettings = {
      1:{ bpm: 80,  speed: .52, scoreToClear: 25000 },
      2:{ bpm:120,  speed: .62, scoreToClear: 75000 },
      3:{ bpm:150,  speed: .72, scoreToClear:150000 }
    };

    function showScreen(id){
      document.querySelectorAll('.screen-overlay').forEach(s=>s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    // ====== ゲーム開始と進行 ======
    function setDifficulty(level){
      if(level > unlockedLevel) return;
      currentLevel = level;
      const s = difficultySettings[level];
      bpm = s.bpm; noteSpeedMultiplier = s.speed; scoreToClearLevel = s.scoreToClear;
      startGame();
    }

    function startGame(){
      showScreen('gameContent');
      score=0; combo=0; notes.forEach(n=>n.element.remove()); notes=[];
      isGameRunning=true;
      scoreDisplay.textContent=score;
      comboDisplay.textContent=combo;
      scoreGoalDisplay.textContent=scoreToClearLevel;

      // BGM（失敗しても継続）
      bgm.volume=.5;
      bgm.play().catch(()=>{ console.log('Autoplay was blocked. Will play on first player input.'); });

      clearInterval(noteSpawnInterval);
      noteSpawnInterval = setInterval(spawnNote, (60 / bpm) * 1000);
      requestAnimationFrame(gameLoop);
    }

    function spawnNote(){
      const type = noteTypes[Math.floor(Math.random()*noteTypes.length)];
      const el = document.createElement('div');
      el.className = 'note ' + type;
      el.style.top = `${Math.random()*(stage.clientHeight-50)}px`;
      const note = { element: el, type, spawnTime: performance.now() };
      notes.push(note);
      stage.appendChild(el);
    }

    function gameLoop(now){
      if(!isGameRunning) return;

      const targetX = stage.clientWidth * .3;
      const noteSpeed = ((bpm/60)*200)*noteSpeedMultiplier;

      for(let i=notes.length-1;i>=0;i--){
        const note = notes[i];
        const elapsed = now - note.spawnTime;
        const newRight = (noteSpeed * (elapsed/1000));
        note.element.style.right = `${newRight}px`;

        // 画面外・ミス判定
        if(stage.clientWidth - newRight < targetX - 60){
          if(note.element.style.opacity !== '0'){
            combo = 0; comboDisplay.textContent = combo;
            showFeedback('Miss','miss');
          }
          note.element.style.opacity = '0';
          note.element.remove();
          notes.splice(i,1);
        }
      }

      if(score >= scoreToClearLevel){
        isGameRunning=false; clearInterval(noteSpawnInterval);
        bgm.pause(); bgm.currentTime=0;
        setTimeout(()=>{
          if(currentLevel < 3){
            showScreen('levelClearScreen');
            if(currentLevel === unlockedLevel) unlockedLevel = currentLevel + 1;
          }else{
            finalScoreDisplay.textContent = score;
            showScreen('endingScreen');
          }
        },800);
        return;
      }

      requestAnimationFrame(gameLoop);
    }

    // ====== 入力・判定・キャラアクション ======
    function handleInput(type){
      if(!isGameRunning) return;

      if(bgm.paused){
        bgm.play().catch(()=>{ /* 何もしない */ });
      }

      let best=null, closest=Infinity;
      const targetX = stage.clientWidth * .3;

      notes.forEach(n=>{
        const noteCenterX = stage.clientWidth - n.element.offsetLeft - (n.element.clientWidth/2);
        const d = Math.abs(noteCenterX - targetX);
        if(n.type===type && d<120 && d<closest){ closest=d; best=n; }
      });

      if(best){
        const noteCenterX = stage.clientWidth - best.element.offsetLeft - (best.element.clientWidth/2);
        const d = Math.abs(noteCenterX - targetX);
        const T_PERF=10, T_GREAT=30, T_GOOD=60;
        if(d<T_PERF){ score += 500 + (combo*10); combo++; showFeedback('Perfect!','perfect'); }
        else if(d<T_GREAT){ score += 300 + (combo*5); combo++; showFeedback('Great!','great'); }
        else if(d<T_GOOD){ score += 100 + (combo*2); combo++; showFeedback('Good!','good'); }
        else { combo=0; showFeedback('Miss','miss'); }
        notes = notes.filter(n=>n!==best);
        best.element.remove();
      }else{
        combo=0; showFeedback('Miss','miss');
      }

      scoreDisplay.textContent=score; comboDisplay.textContent=combo;

      // ボタン＆キャラにアクション
      triggerCharacter(type);
      const btn = document.getElementById(type+'Button');
      if(btn){
        btn.classList.add('active',type);
        setTimeout(()=>btn.classList.remove('active',type),120);
      }
    }

    function triggerCharacter(action){
      characterSvg.classList.add(action);
      // 連打でも戻りが破綻しないよう短いタイマーで都度リセット
      setTimeout(()=>characterSvg.classList.remove(action),160);
    }

    function showFeedback(text, style){
      const el = document.createElement('div');
      el.className = `feedback-text ${style}`;
      el.textContent = text;
      stage.appendChild(el);
      setTimeout(()=>el.remove(), 820);
    }

    // ====== UIイベント ======
    document.getElementById('startButton').addEventListener('click', ()=>showScreen('difficultySelectScreen'));
    easyButton.addEventListener('click', ()=>setDifficulty(1));
    normalButton.addEventListener('click', ()=>setDifficulty(2));
    hardButton.addEventListener('click', ()=>setDifficulty(3));
    nextLevelButton.addEventListener('click', ()=>setDifficulty(currentLevel+1));
    playAgainButton.addEventListener('click', ()=>showScreen('startScreen'));

    document.addEventListener('keydown', (e)=>{
      const action = keyMap[e.code];
      if(action && isGameRunning) handleInput(action);
    });

    punchButton.addEventListener('click', ()=>handleInput('punch'));
    kickButton .addEventListener('click', ()=>handleInput('kick'));
    jumpButton .addEventListener('click', ()=>handleInput('jump'));

    // ====== Firebase 無効化版：直接スタート画面へ ======
    window.onload = () => { showScreen('startScreen'); };
  </script>
</body>
</html>
